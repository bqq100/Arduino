#include <Ultrasonic.h>
#include <QueueArray.h>
#include <RunningMedian.h>
Ultrasonic ultrasonic(12,13);

unsigned long previousMillis = 0;        // will store last time LED was updated
unsigned long interval = 1000;           // interval at which to blink (milliseconds)

uint8_t errorFlag = 0;
uint8_t pumpFlag = 0;
uint8_t lowFlag = 0;
uint8_t highFlag = 0;
uint8_t missed = 0;

uint8_t i = 0;
uint8_t j = 0;

int lastSecVal = 0;
float last5MinVal = 0;

RunningMedian<int,10> lastSecond;
RunningMedian<int,150> last5Minute;

void setup() {
 Serial.begin(9600);
 Serial.println("Liquid Level Detector");
 delay(1000);
}

void loop()
{
  int value = ultrasonic.Ranging(CM);
  
  if (value < 255 && value > 0){
    lastSecond.add(value);
    last5Minute.add(value);
    if (++i>=10){
      i=0;
      lastSecond.getMedian(lastSecVal);
    }
    if (++j>=150){
      j=0;
      last5Minute.getAverage(100,last5MinVal);
    }
    missed = 0;
  }else{
    missed++;
  }

  if (lastSecVal > 210)
    lowFlag = 1;
  else 
    lowFlag = 0;  
  if(lastSecVal < 130)
    highFlag = 1;
  else 
    highFlag = 0;
  if(last5MinVal < 145 && lastSecVal < 160)
    pumpFlag = 1;
  else
    pumpFlag = 0;
  if (missed > 5)
    errorFlag = 1;
  else
    errorFlag = 0;

  char line[50];  
  if (pumpFlag)
    sprintf(line,"PUMP ON");
  if (lowFlag)
    sprintf(line,"ERROR: Water too low (%d mm)",lastSecVal);
  if (highFlag)
    sprintf(line,"ERROR: Water too high (%d mm)",lastSecVal);
  if (errorFlag)
    sprintf(line,"ERROR: Generic Error Detected");
  if (pumpFlag || lowFlag || highFlag || errorFlag)
    Serial.println(line);
   
  unsigned long currentMillis = millis();
  if(currentMillis - previousMillis > interval) {
    previousMillis = currentMillis;   
    sprintf(line,"LongAvg: %d ShortAvg: %d Sensor: %d",(int)last5MinVal,lastSecVal,value);
    Serial.println(line);
  }
   
  delay(100);
}

